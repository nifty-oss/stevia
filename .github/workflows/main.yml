name: Main

on:
  push:
    branches: [main]
  pull_request:

env:
  CACHE: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          cargo-cache-key: cargo-lint
          toolchain: format, lint
          components: hack, miri, spellcheck

      - name: cargo-clippy
        run: ./make.sh clippy

      - name: cargo-fmt
        run: ./make.sh format

      - name: cargo-doc
        run: ./make.sh doc

      - name: cargo-hack
        run: ./make.sh hack

      - name: cargo-miri
        run: ./make.sh miri

      - name: cargo-spellcheck
        run: ./make.sh spellcheck

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          cargo-cache-key: cargo-build
          toolchain: build
          solana: true

      - name: cargo-build
        run: ./make.sh build

      - name: cargo-build-sbf
        run: ./make.sh build-sbf

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Git Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          cargo-cache-key: cargo-test
          toolchain: test

      - name: cargo-test
        run: ./make.sh test
